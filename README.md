

## Описание

Данный проект представляет собой API для взаимодействия с базой данных интернет-магазина. 

## Установка


1. Установить данный проект.
2. Установить Redis и PostgreSQL
3. Выполнить скрипт `...` для создания и наполнения тестовой базы данных PostgreSQL
4. В файле dev.bat установить значения переменных окружения для конфигурации подключения к Redis и базе данных


## API Функционал

### 1. Регистрация и авторизация
+ Страница приветствия.
Если пользователь авторизован и его сессия ещё не истекла, запрос возвращает имя пользователя, иначе "гость".  
```GET /```

+ Регистрация.
Проверяет никнейм пользователя на уникальность, в случае соответствия шифрует пароль при помощи bscript (https://github.com/uzudil/bscript) и добавляет пользователя в базу. Роль пользователя всегда будет установлена как 'user'
```POST /users/signup```
```json
{
  "username": "TestUser15",
  "password": "12345"
}
```
+ Авторизация.
Проверяет никнейм и пароль пользователя, в случае соответствия создаёт сессию пользователя в Redis и устанавливает cookie с id сессии в браузер.
```POST /users/signin```
```json
{
  "username": "TestUser15",
  "password": "12345"
}
```

+ Продление сессии.
Если сессия пользователя ещё не истекла, продлевает время сессии в Redis и в cookie браузера. 
```GET /users/refresh```

+ Выход из системы.
Удаляет сессию пользователя из Redis и из cookie браузера.
```GET /users/logout```

+ Смена пароля.
Для авторизованного пользователя проверяет старый пароль на соответствие, шифрует и обновляет пароль в базе данных.
```POST /users/change_password```
```json
{
  "old_password": "12345",
  "new_password": "12346"
}
```

+ Добавление менеджером нового пользователя.
Для авторизованного пользователя с ролью менеджера позволяет добавить нового пользователя с ролью 'user' или 'manager'. Если роль не задана, она будет установлена как 'user'
```POST /users/create```
```json
{
  "username": "TestUser18",
  "password": "123456",
  "role": "manager"
}
```

### 2. Получение, обновление, добавление продукта и его свойств

+ Получение данных продукта по Id.
Возвращает информацию о продукте из бд, если продукт с данным id существует
```GET /products/33```

+ Обновление данных продукта по Id.
Проверяет указанные поля на корректность и в случае соответствия обновляет эти поля в базе данных. Не указанные в запросе и некорректные поля не обновляются. Возвращает обновлённый продукт.
```POST /products/33/update```
```json
{
    "name":"Spring Milana Fashionista Doll",
    "manufacturer":"Barbie",
	"quantity":100,
	"price": 27790.99,
    "description":"Description of the doll",
	"available":true
}
```

+ Добавление/обновление атрибутов продукта по Id продукта.
Проверяет указанные атрибуты на корректность (id атрибута существует).  
Корректные атрибуты: если атрибут ранее был у продукта, его значение обновляется, иначе будет добавлен новый для продукта атрибут.  
Некорректные атрибуты: игнорируются в запросе к бд, но добавляются в список для вывода пользователю.
Возвращает список некорректных атрибутов (при наличии).   
Имя атрибута в запросе не обязательно.
```POST /products/33/update/attribute```
```json
[
    {
	    "attribute_id": 2,
	    "attribute_name" : "country of origin",
	    "attribute_value": "Poland"
    },
    {
	    "attribute_id": 4,
	    "attribute_value": "7+"
    }
]
```

+ Удаление атрибутов продукта по Id продукта.
Удаляет атрибуты продукта в соответствии с переданными id атрибутов. Возвращает количество улалённых атрибутов (которое может быть меньше, чем количество переданных, если какие-то из переданных атрибутов отсутствовали у продукта)
```DELETE /products/33/delete/attribute```
```json
[
  6, 20
]
```

+ Обновление категории продукта по Id продукта.
Устанавливает категорию продукта в соответствии с переданным id категории. Если значение для категории продукта было установлено, обновляет его, иначе устанавливает новое значение.
Имя категории в запросе не обязательно.
```POST /products/33/update/category```
```json
{
	"category_id": 20,
	"category_name": "Classic dolls"
}
```

+ Удаление категории продукта по Id продукта.
Удаляет категорию продукта, если она была установлена.
```DELETE /products/33/update/category```

### 3. Получение, обновление, добавление атрибутов и категорий

+ Получение дерева категорий.
Возвращает дерево категрий, определяя вложенность по свойству parent_id. Если parent_id установлено в 0, категрия не отображается в дереве.
```GET /categories```

+ Получение подкатегорий и продуктов для данной категории.
Возвращает список категорий, непосредственно вложенных в данную категорию и список продуктов для данной категории при наличии того или другого.
```GET /categories/5```

+ Создание нового атрибута.
Проверяет имя атрибута на уникальность, при соответствии добавляет новый атрибут в бд, возвращает id нового атрибута.
```POST /attributes/create```
```json
{
    "Name": "new_attribute"
}
```

+ Изменение имени атрибута.
Проверяет имя атрибута на уникальность, при соответствии изменяет имя атрибута в бд.
```POST /attributes/6/update```
```json
{
    "Name": "material"
}
```

+ Создание новой категории.
Создаёт новую категорию с указанным именем. Параметр parent_id при отсутствии устанавливается в 0. Это означает, что категория не будет отображаться в дереве категорий.
```POST /categories/create```
```json
{
    "Name": "LEGO New",
    "parent_id": 5
}
```

+ Изменение свойств категории.
Изменяет переданные свойства категории: name и/или parent_id. Не переданные свойства не изменяются
```POST /categories/29/update```
```json
{
    "parent_id": 1
}
```

### 4. Корзина пользователя

+ Получение списка продуктов из корзины.
При наличии в браузере Cookie с id корзины возвращает список продуктов из Redis, соответствующий данному id (список может быть пустым). Иначе возвращает пустой список
```GET /cart```

+ Добавление продукта в корзину.
Проверяет наличие продукта в бд и соответствие количества требуемому в запросе.
Затем ищет в браузере Cookie с id корзины, при отсутствии создаёт id и устанавливает в Cookie. Получает из Redis список продуктов, добавляет в него новый продукт, или изменяет количество (если продукт был ранее добавлен). После чего устанавливает в Redis новый список продуктов. 
```POST /cart```
```
{
  "ProductId": 13,
  "Quantity": 2
}
```

+ Удаление продукта из корзины.
Проверяет в браузере Cookie с id корзины, при наличии получает из Redis список продуктов. Если количество для удаления меньше, чем количество продукта, уменьшает количество, иначе удаляет продукт из списка. После чего устанавливает в Redis новый список продуктов.  
Если количество для удаление не задано, оно устанавливается в 1.
```DELETE /cart```
```
{
  "ProductId": 13,
  "Quantity": 2
}
```

### 5. Оформление, подтверждение, отмена заказа.

+ Оформление заказа.
Для авторизованного пользователя. Получает корзину пользователя из Redis, проверяет доступность и количество продуктов в бд, при соответствии требованиям создаёт в бд заказ со статусом "created", возвращает id созданного заказа.
```GET /cart/buy```

+ Отмена заказа.
Для авторизованного пользователя. В соответствии с id сессии получает из бд id пользователя, проверяет наличие заказа для данного пользователя, статус заказа и время заказа. Если с момента создания заказа прошло меньше 10 минут и статус заказа 'created', статус заказа устанавливается в 'cancelled'
```GET /orders/6/cancel```

+ Подтверждение или отклонение заказа.
Для менеджера. Корректные значения для установки 'confirmed' и 'rejected'. Только статус заказа 'created' может быть обновлён. При установке значения 'confirmed' в бд проверяются доступность и количество продуктов из заказа и если всё корректно, количесиво каждого продукта уменьшается в бд в соответствии с количеством в заказе.
```POST /orders/6/update```
```
{
  "confirmed"
}
```

+ Получение информации о заказе.
Для авторизованного пользователя. Получает из бд в данные заказа и список продуктов в заказе.
```GET /orders/6```

+ Получение информации о заказе.
Для авторизованного пользователя. Получает из бд данные и список продуктов для всех заказов пользователя.
```GET /orders/```

+ Поиск заказов по времени заказа, пользователю или продукту.
Для менеджера. Получает из бд данные и список продуктов для заказов по критериям:  
промежуток времени, в который сделан заказ,  
id пользователя,  
id продукта в заказе.  
Все критерии поиска опциональны.
```GET /orders/search?timestart=2024-01-02 00:00:00&timeend=2024-03-15 23:59:59&userid=6&productid=21&status=confirmed```  
```GET /orders/search?userid=6&status=confirmed```  
```GET /orders/search```



## Примечание

# This is a Heading h1
## This is a Heading h2
###### This is a Heading h6

## Emphasis

*This text will be italic*  
_This will also be italic_

**This text will be bold**  
__This will also be bold__

_You **can** combine them_

## Lists

### Unordered

* Item 1
* Item 2
* Item 2a
* Item 2b
    * Item 3a
    * Item 3b

### Ordered

1. Item 1
2. Item 2
3. Item 3
    1. Item 3a
    2. Item 3b

## Images

![This is an alt text.](/image/sample.webp "This is a sample image.")

## Links

You may be using [Markdown Live Preview](https://markdownlivepreview.com/).

## Blockquotes

> Markdown is a lightweight markup language with plain-text-formatting syntax, created in 2004 by John Gruber with Aaron Swartz.
>
>> Markdown is often used to format readme files, for writing messages in online discussion forums, and to create rich text using a plain text editor.

## Tables

| Left columns  | Right columns |
| ------------- |:-------------:|
| left foo      | right foo     |
| left bar      | right bar     |
| left baz      | right baz     |

## Blocks of code

```
let message = 'Hello world';
alert(message);
```

## Inline code

This web site is using `markedjs/marked`.
