

## Описание

Данный проект представляет собой API для взаимодействия с базой данных интернет-магазина.

## Установка

1. Склонировать данный проект.
2. Установить Redis и PostgreSQL. Для PostgreSQL создать базу данных и схему по своему усмотрению.
3. Выполнить скрипт `./scripts/init.sql` для создания структуры таблиц и скрипт `./scripts/seed.sql` для наполнения базы тестовыми данными.
4. В файле `dev.bat` установить значения переменных окружения для конфигурации подключения к Redis и базе данных.
5. Запустить исполняемый файл `dev.bat`

| Переменная         | Значение по умолчанию | Описание |
|--------------------|----------------------|----------|
| `DATABASE_HOST`    | `127.0.0.1`          | Хост базы данных PostgreSQL. |
| `DATABASE_USER`    | `your_user`          | Пользователь базы данных. |
| `DATABASE_PASSWORD`| `your_password`      | Пароль пользователя базы данных. |
| `DATABASE_PORT`    | `5432`               | Порт для подключения к базе данных. |
| `DATABASE_NAME`    | `your_db_name`       | Название базы данных. |
| `REDIS_HOST`       | `127.0.0.1`          | Хост сервера Redis. |
| `REDIS_PORT`       | `6379`               | Порт для подключения к серверу Redis. |

## API Функционал

### 1. Регистрация и авторизация

#### Регистрация.
```POST /users/signup```  
Проверяет никнейм пользователя на уникальность, в случае соответствия шифрует пароль при помощи bscript (https://github.com/uzudil/bscript) и добавляет пользователя в базу. Роль пользователя всегда будет установлена как 'user'  
Пример запроса:  
```json
{
  "username": "TestUser15",
  "password": "12345"
}
```
#### Авторизация.
```POST /users/signin```  
Проверяет никнейм и пароль пользователя, в случае соответствия создаёт сессию пользователя в Redis и устанавливает cookie с id сессии в браузер.  
Пример запроса:  
```json
{
  "username": "TestUser15",
  "password": "12345"
}
```

#### Продление сессии.
```GET /users/refresh```  
Если сессия пользователя ещё не истекла, продлевает время сессии в Redis и в cookie браузера. 


#### Выход из системы.
```GET /users/logout```  
Удаляет сессию пользователя из Redis и из cookie браузера.


#### Смена пароля.
```POST /users/change_password```  
Для авторизованного пользователя проверяет старый пароль на соответствие, шифрует и обновляет пароль в базе данных.  
Пример запроса:  
```json
{
  "old_password": "12345",
  "new_password": "12346"
}
```

#### Добавление менеджером нового пользователя.
```POST /users/create```  
Для авторизованного пользователя с ролью менеджера позволяет добавить нового пользователя с ролью 'user' или 'manager'. Если роль не задана, она будет установлена как 'user'  
Пример запроса:  
```json
{
  "username": "TestUser18",
  "password": "123456",
  "role": "manager"
}
```

### 2. Получение, обновление, добавление продукта и его свойств

#### Получение данных продукта по Id.
```GET /products/33```  
Возвращает информацию о продукте из бд, если продукт с данным id существует

#### Обновление данных продукта по Id.
```POST /products/33/update```  
Проверяет указанные поля на корректность и в случае соответствия обновляет эти поля в базе данных. Не указанные в запросе и некорректные поля не обновляются. Возвращает обновлённый продукт.  
Пример запроса:  
```json
{
    "name":"Spring Milana Fashionista Doll",
    "manufacturer":"Barbie",
	"quantity":100,
	"price": 27790.99,
    "description":"Description of the doll",
	"available":true
}
```

#### Добавление/обновление атрибутов продукта по Id продукта.
```POST /products/33/update/attribute```  
Проверяет указанные атрибуты на корректность (id атрибута существует).  
Корректные атрибуты: если атрибут ранее был у продукта, его значение обновляется, иначе будет добавлен новый для продукта атрибут.  
Некорректные атрибуты: игнорируются в запросе к бд, но добавляются в список для вывода пользователю.
Возвращает список некорректных атрибутов (при наличии).   
Пример запроса:  
```json
[
    {
	    "attribute_id": 2,
	    "attribute_value": "Poland"
    },
    {
	    "attribute_id": 4,
	    "attribute_value": "7####"
    }
]
```

#### Удаление атрибутов продукта по Id продукта.
```DELETE /products/33/delete/attribute```  
Удаляет атрибуты продукта в соответствии с переданными id атрибутов. Возвращает количество улалённых атрибутов (которое может быть меньше, чем количество переданных, если какие-то из переданных атрибутов отсутствовали у продукта)  
```json
[
  6, 20
]
```

#### Обновление категории продукта по Id продукта.
```POST /products/33/update/category```  
Устанавливает категорию продукта в соответствии с переданным id категории. Если значение для категории продукта было установлено, обновляет его, иначе устанавливает новое значение.
Имя категории в запросе не обязательно.  
Пример запроса:  
```json
{
	"category_id": 20,
	"category_name": "Classic dolls"
}
```

#### Удаление категории продукта по Id продукта.
```DELETE /products/33/update/category```  
Удаляет категорию продукта, если она была установлена.


### 3. Получение, обновление, добавление атрибутов и категорий

#### Получение дерева категорий.
```GET /categories```  
Возвращает дерево категрий, определяя вложенность по свойству parent_id. Если parent_id установлено в 0, категрия не отображается в дереве.


#### Получение подкатегорий и продуктов для данной категории.
```GET /categories/5```  
Возвращает список категорий, непосредственно вложенных в данную категорию и список продуктов для данной категории при наличии того или другого.


#### Создание нового атрибута.
```POST /attributes/create```  
Проверяет имя атрибута на уникальность, при соответствии добавляет новый атрибут в бд, возвращает id нового атрибута.
Пример запроса:  
```json
{
    "name": "new_attribute"
}
```

#### Изменение имени атрибута.
```POST /attributes/6/update```  
Проверяет имя атрибута на уникальность, при соответствии изменяет имя атрибута в бд.  
Пример запроса:  
```json
{
    "name": "material"
}
```

#### Создание новой категории.
```POST /categories/create```  
Создаёт новую категорию с указанным именем. Параметр parent_id при отсутствии устанавливается в 0. Это означает, что категория не будет отображаться в дереве категорий.  
Пример запроса:  
```json
{
    "name": "LEGO New",
    "parent_id": 5
}
```

#### Изменение свойств категории.
```POST /categories/29/update```  
Изменяет переданные свойства категории: name и/или parent_id. Не переданные свойства не изменяются  
Пример запроса:  
```json
{
    "parent_id": 1
}
```

### 4. Корзина пользователя

#### Получение списка продуктов из корзины.
```GET /cart```  
При наличии в браузере Cookie с id корзины возвращает список продуктов из Redis, соответствующий данному id (список может быть пустым). Иначе возвращает пустой список


#### Добавление продукта в корзину.
```POST /cart```  
Проверяет наличие продукта в бд и соответствие количества требуемому в запросе. Затем ищет в браузере Cookie с id корзины, при отсутствии создаёт id и устанавливает в Cookie. Получает из Redis список продуктов, добавляет в него новый продукт, или изменяет количество (если продукт был ранее добавлен). После чего устанавливает в Redis новый список продуктов.  
Пример запроса:  
```json
{
  "ProductId": 13,
  "Quantity": 2
}
```

#### Удаление продукта из корзины.
```DELETE /cart```  
Проверяет в браузере Cookie с id корзины, при наличии получает из Redis список продуктов. Если количество для удаления меньше, чем количество продукта, уменьшает количество, иначе удаляет продукт из списка. После чего устанавливает в Redis новый список продуктов.  
Если количество для удаление не задано, оно устанавливается в 1.
Пример запроса:  
```json
{
  "ProductId": 13,
  "Quantity": 2
}
```

### 5. Оформление, подтверждение, отмена заказа.

#### Оформление заказа.
```GET /cart/buy```  
Для авторизованного пользователя. Получает корзину пользователя из Redis, проверяет доступность и количество продуктов в бд, при соответствии требованиям создаёт в бд заказ со статусом "created", возвращает id созданного заказа.


#### Отмена заказа.
```GET /orders/6/cancel```  
Для авторизованного пользователя. В соответствии с id сессии получает из бд id пользователя, проверяет наличие заказа для данного пользователя, статус заказа и время заказа. Если с момента создания заказа прошло меньше 10 минут и статус заказа 'created', статус заказа устанавливается в 'cancelled'


#### Подтверждение или отклонение заказа.
```POST /orders/6/update```  
Для менеджера. Корректные значения для установки 'confirmed' и 'rejected'. Только статус заказа 'created' может быть обновлён. При установке значения 'confirmed' в бд проверяются доступность и количество продуктов из заказа и если всё корректно, количесиво каждого продукта уменьшается в бд в соответствии с количеством в заказе.  
Пример запроса:  
```json
{
  "status":"confirmed"
}
```

#### Получение информации о заказе.
```GET /orders/6```  
Для авторизованного пользователя. Получает из бд в данные заказа и список продуктов в заказе.

#### Получение информации обо всех заказах.
```GET /orders/```  
Для авторизованного пользователя. Получает из бд данные и список продуктов для всех заказов пользователя.


#### Поиск заказов по времени заказа, пользователю или продукту.
Для менеджера. Получает из бд данные и список продуктов для заказов по критериям:  
промежуток времени, в который сделан заказ,  
статус заказа,  
id пользователя,   
id продукта в заказе.  
Все критерии поиска опциональны.
```GET /orders/search?timestart=2024-01-02 00:00:00&timeend=2024-03-15 23:59:59&userid=6&productid=21&status=confirmed```  
```GET /orders/search?userid=6&status=confirmed```  
```GET /orders/search?status=rejected```



